- name: Forward 80/443 on Hetzner to Traefik VIP over WireGuard
  hosts: gateway
  become: true
  tasks:
    - name: Enable forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        state: present
        reload: yes

    - name: DNAT 80/443 to Traefik VIP (iptables)
      shell: |
        set -e
        iptables -t nat -C PREROUTING -i eth0 -p tcp --dport 80  -j DNAT --to-destination {{ traefik_vip }}:80  2>/dev/null || \
          iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80  -j DNAT --to-destination {{ traefik_vip }}:80

        iptables -t nat -C PREROUTING -i eth0 -p tcp --dport 443 -j DNAT --to-destination {{ traefik_vip }}:443 2>/dev/null || \
          iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j DNAT --to-destination {{ traefik_vip }}:443

        iptables -C FORWARD -p tcp -d {{ traefik_vip }} --dport 80  -j ACCEPT 2>/dev/null || iptables -A FORWARD -p tcp -d {{ traefik_vip }} --dport 80  -j ACCEPT
        iptables -C FORWARD -p tcp -d {{ traefik_vip }} --dport 443 -j ACCEPT 2>/dev/null || iptables -A FORWARD -p tcp -d {{ traefik_vip }} --dport 443 -j ACCEPT

    - name: (Optional but recommended) Persist iptables rules
      apt:
        name: iptables-persistent
        state: present
        update_cache: yes

    - name: Save rules
      shell: netfilter-persistent save