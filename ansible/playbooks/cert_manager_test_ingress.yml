- name: Test cert-manager (real cert via HTTP-01 + Traefik)
  hosts: k3s_servers[0]
  become: true
  gather_facts: false

  vars:
    test_ns: "whoami-tls"
    test_host: "wlodzimierrr.co.uk"
    test_secret: "whoami-tls"

  tasks:
    - name: Create namespace
      shell: |
        set -euo pipefail
        sudo kubectl create ns {{ test_ns }} --dry-run=client -o yaml | sudo kubectl apply -f -
      args:
        executable: /bin/bash

    - name: Apply whoami deployment/service/ingress with TLS
      copy:
        dest: /tmp/whoami-tls.yml
        mode: "0644"
        content: |
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: whoami
            namespace: {{ test_ns }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: whoami
            template:
              metadata:
                labels:
                  app: whoami
              spec:
                containers:
                  - name: whoami
                    image: traefik/whoami:v1.10.1
                    ports:
                      - containerPort: 80
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: whoami
            namespace: {{ test_ns }}
          spec:
            selector:
              app: whoami
            ports:
              - name: http
                port: 80
                targetPort: 80
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: whoami
            namespace: {{ test_ns }}
            annotations:
              cert-manager.io/cluster-issuer: {{ clusterissuer_name }}
          spec:
            ingressClassName: {{ traefik_ingress_class | default("traefik") }}
            tls:
              - hosts:
                  - {{ test_host }}
                secretName: {{ test_secret }}
            rules:
              - host: {{ test_host }}
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: whoami
                          port:
                            number: 80

    - name: Apply manifest
      shell: |
        set -euo pipefail
        sudo kubectl apply -f /tmp/whoami-tls.yml
      args:
        executable: /bin/bash

    - name: Watch certificate status
      shell: |
        set -euo pipefail
        echo "== Certificate =="
        sudo kubectl -n {{ test_ns }} get certificate
        echo "== Orders =="
        sudo kubectl -n {{ test_ns }} get orders.acme.cert-manager.io || true
        echo "== Challenges =="
        sudo kubectl -n {{ test_ns }} get challenges.acme.cert-manager.io || true
      args:
        executable: /bin/bash