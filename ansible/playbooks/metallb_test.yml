- name: Test MetalLB by creating a LoadBalancer service
  hosts: k3s_servers
  gather_facts: false
  tasks:
    - name: Pick first k3s server node
      set_fact:
        k3s_first_server: "{{ groups['k3s_servers'][0] }}"
      run_once: true

    - name: Deploy nginx test + expose LoadBalancer
      ansible.builtin.shell: |
        set -euo pipefail
        sudo kubectl create deployment nginx-test --image=nginx --dry-run=client -o yaml | sudo kubectl apply -f -
        sudo kubectl expose deployment nginx-test --type=LoadBalancer --port=80 --dry-run=client -o yaml | sudo kubectl apply -f -
        sudo kubectl get svc nginx-test -o wide
      args:
        executable: /bin/bash
      delegate_to: "{{ k3s_first_server }}"
      run_once: true

    - name: Wait for external IP assignment
      ansible.builtin.shell: |
        set -euo pipefail
        for i in $(seq 1 60); do
          ip=$(sudo kubectl get svc nginx-test -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || true)
          if [ -n "${ip}" ]; then
            echo "LB_IP=${ip}"
            exit 0
          fi
          sleep 2
        done
        echo "Timed out waiting for external IP"
        exit 1
      args:
        executable: /bin/bash
      delegate_to: "{{ k3s_first_server }}"
      run_once: true
      changed_when: false